name:  Terraform Workflow   					#workflow
on:                                   
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
    types:
      - closed
  workflow_dispatch : {}

permissions:
  id-token: write # required for requesting the JWT 
  pull-requests: read
  contents: read


jobs:
  detect-changes:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest		 #Runner
    outputs:
      all-changes: ${{ steps.changed-files.outputs.all_changed_files }}
      matrix-input-data: ${{ steps.create-matrix.outputs.matrix }}
      all-delete-changes: ${{ steps.changed-files.outputs.deleted_files }}
      matrix-delete-data: ${{ steps.create-delete-matrix.outputs.delete-matrix }}
    
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
    
    - name: Run changed-files with dir_names
      id: changed-files
      uses: tj-actions/changed-files@v45
      with:
        files: |
            **.tf
            environments/**.tf
        dir_names: true
        matrix: true
        dir_names_deleted_files_include_only_deleted_dirs: true
    
    
    
    - name: Detect Changes
      id: detect-changes
      run: |
        MATRIX_ENTRIES=()

        # Get the output of changed folders
        CHANGED_FOLDERS="${{ steps.changed-files.outputs.all_changed_files }}"
        echo "Raw changed folders output: $CHANGED_FOLDERS"

        # Remove square brackets and split the folders into an array
        CLEANED_CHANGED_FOLDERS="${CHANGED_FOLDERS//[\[\]]/}"
        IFS=',' read -r -a CHANGED_FOLDERS_ARRAY <<< "$CLEANED_CHANGED_FOLDERS"

        # Loop through the cleaned folders and build matrix entries
        for folder in "${CHANGED_FOLDERS_ARRAY[@]}"; do
          folder=$(echo "$folder" | xargs) # Trim whitespace
          if [[ -n "$folder" ]]; then
            ENV_NAME=$(basename "$(dirname "$folder")") # Extract the environment name from the path
            MATRIX_ENTRIES+=("{\"path\":\"$folder\",\"environment\":\"$ENV_NAME\"}")
          fi
        done

        # Join all entries into a JSON array and wrap it in a 'config' object
        MATRIX_JSON=$(IFS=, ; echo "${MATRIX_ENTRIES[*]}")
        MATRIX_JSON="{\"config\":[${MATRIX_JSON}]}"
        
        # Wrap the whole JSON string with single quotes
        FINAL_OUTPUT="'${MATRIX_JSON}'"
        
        echo "Generated matrix data: $FINAL_OUTPUT" # Debugging output

        # Set output for the matrix data in the exact format required
        echo "matrix-data=$FINAL_OUTPUT" >> $GITHUB_OUTPUT



    - name: Detect Deleted Folders
      id: detect-deleted-folders
      run: |
        MATRIX_ENTRIES=()

        # Get the output of changed folders
        CHANGED_FOLDERS="${{ steps.changed-files.outputs.deleted_files }}"
        echo "Raw changed folders output: $CHANGED_FOLDERS"

        # Remove square brackets and split the folders into an array
        CLEANED_CHANGED_FOLDERS="${CHANGED_FOLDERS//[\[\]]/}"
        IFS=',' read -r -a CHANGED_FOLDERS_ARRAY <<< "$CLEANED_CHANGED_FOLDERS"

        # Loop through the cleaned folders and build matrix entries
        for folder in "${CHANGED_FOLDERS_ARRAY[@]}"; do
          folder=$(echo "$folder" | xargs) # Trim whitespace
          if [[ -n "$folder" ]]; then
            ENV_NAME=$(basename "$(dirname "$folder")") # Extract the environment name from the path
            MATRIX_ENTRIES+=("{\"path\":\"$folder\",\"environment\":\"$ENV_NAME\"}")
          fi
        done

        # Join all entries into a JSON array and wrap it in a 'config' object
        MATRIX_JSON=$(IFS=, ; echo "${MATRIX_ENTRIES[*]}")
        MATRIX_JSON="{\"config\":[${MATRIX_JSON}]}"
        
        # Wrap the whole JSON string with single quotes
        FINAL_OUTPUT="'${MATRIX_JSON}'"
        
        echo "Generated matrix data for deleted folders: $FINAL_OUTPUT" # Debugging output

        # Set output for the matrix data in the exact format required
        echo "matrix-data-deleted-folders=$FINAL_OUTPUT" >> $GITHUB_OUTPUT

      
    - name: Debug Matrix Data
      run: echo "${{ steps.detect-changes.outputs.matrix-data }}"

    - name: Debug Deleted Folder Matrix Data
      run: echo "${{ steps.detect-deleted-folders.outputs.matrix-data-deleted-folders }}"

    - name: Generate Matrix
      id: create-matrix
      run: |
        MATRIX=${{ steps.detect-changes.outputs.matrix-data }}
        #MATRIX='{"config":[{"path":"environments/production/ec2","environment":"production"},{"path":"environments/staging/ec2","environment":"staging"}]}'
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

    - name: Generate Deleted Folders Matrix
      id: create-delete-matrix
      run: |
        MATRIX=${{ steps.detect-deleted-folders.outputs.all-delete-changes }}
        echo "delete-matrix=$MATRIX" >> $GITHUB_OUTPUT

    - name: List all changed folders
      env:
        ALL_CHANGED_FOLDERS: ${{ steps.changed-files.outputs.matrix-data-deleted-folders }}
      run: |
        for file in ${ALL_CHANGED_FOLDERS}; do
          echo "$file was changed"
        done

    - name: List all deleted folders
      env:
        ALL_DELETED_FILES: ${{ steps.changed-files.outputs.deleted_files }}
      run: |
        for file in ${ALL_DELETED_FILES}; do
          echo "$file was deleted"
        done

  
  test-terraform-iac:
    if: github.event_name != 'pull_request'
    needs: [detect-changes]
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix-input-data) }}
        #changed_paths: ${{ fromJSON(needs.detect-changes.outputs.all-changes) }}
    #if: always()
    #if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    #if: contains(fromJSON('["push", "pull_request"]'), github.event_name)
    runs-on: ubuntu-latest		 #Runner
    environment: ${{ matrix.config.environment }}
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.9.7"
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}


    - name: Run Terraform Plan
      run: |
          #changed_dirs=$(git diff --name-only ${{ github.event.after }} ${{ github.event.before }} | grep '\.tf$' | grep 'environments/' | cut -d'/' -f1-3 | sort -u)
          echo "Running terraform plan for environment: ${{ matrix.config.environment }} in path: ${{ matrix.config.path }}"
          cd ${{ matrix.config.path }}
          terraform init
          terraform validate
          terraform plan -detailed-exitcode -out=tfplan
          cd - # Go back to the root directory after each plan


    - name: uplaod tfplan files artifacts
      uses: actions/upload-artifact@v4
      with:
        name: all-changed-folders-in-${{ matrix.config.environment }}-${{ strategy.job-index }}
        include-hidden-files: true
        #retention-days: 5
        path: |
          ${{ matrix.config.path  }}/tfplan
          ${{ matrix.config.path  }}/.terraform
          ${{ matrix.config.path  }}/.terraform.lock.hcl
            


  deploy-terraform-iac:
    needs: [detect-changes, test-terraform-iac]
    if: github.ref == 'refs/heads/main'
    #if: github.event.pull_request.merged == true
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix-input-data) }}
    runs-on: ubuntu-latest
    environment: ${{ matrix.config.environment }}

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.9.7"
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Download artifact for ${{ matrix.config.path }}
      uses: actions/download-artifact@v4
      with:
        path: ${{ matrix.config.path }}
        name: all-changed-folders-in-${{ matrix.config.environment }}-${{ strategy.job-index }}
        # merge-multiple: true

    - name: List All files and subfolder files
      run: |
        ls -a
        ls -LRA
        find ~ -type f -name '.*'

    - name: Run Terraform Apply
      run: |
          echo "Running terraform apply for environment: ${{ matrix.config.environment }} in path: ${{ matrix.config.path }}"
          cd ${{ matrix.config.path }}
          ls -a
          chmod -R +x .terraform/* 
          terraform apply --auto-approve -input=false -lock=false tfplan
          cd - # Go back to the root directory after each plan





# Loop through deleted folders and append cleanup jobs to the template
  test-terraform-cleanup:
    needs: [detect-changes]
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix-delete-data) }}
    runs-on: ubuntu-latest
    environment: ${{ matrix.config.environment }}
    steps:

    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch the entire git history to ensure we have access to previous commits

    - name: List all changed files
      env:
        ALL_DELETED_FILES: ${{ needs.detect-changes.outputs.all-delete-changes }}
      run: |
        for file in ${ALL_DELETED_FILES}; do
          echo "$file was deleted"
        done

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v45
      with:
        dir_names: true  # Set to true to capture all file changes
        dir_names_deleted_files_include_only_deleted_dirs: true  # Set to true to capture deleted files
    
    - name: Identify deleted folders
      id: deleted-folders
      run: |
        deleted_folders=$(echo "${{ steps.changed-files.outputs.deleted_files }}" | awk -F'/' '{print $1}' | sort | uniq)
        echo "Deleted folders: $deleted_folders"

    - name: Debug List deleted files
      run: |
        echo "Deleted files:"
        echo "${{ steps.changed-files.outputs.deleted_files }}"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.9.7"

    - name: Get the previous commit SHA
      id: previous-commit
      run: |
        PREVIOUS_SHA=$(git rev-parse HEAD^1)
        echo "PREVIOUS_SHA=$PREVIOUS_SHA" >> $GITHUB_ENV

    - name: Checkout previous commit (overwrite current code)
      uses: actions/checkout@v3
      with:
        ref: ${{ env.PREVIOUS_SHA }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    

    - name: Run Terraform Plan -destroy
      run: |
          echo "Running terraform plan -destroy for environment: ${{ matrix.config.environment }} in path: ${{ matrix.config.path }}"
          ls -LRA
          cd ${{ matrix.config.path }}
          # terraform init
          # terraform validate
          # terraform plan -destroy -detailed-exitcode -out=tfplan
          # cd - # Go back to the root directory after each plan


    - name: uplaod tfplan files artifacts
      uses: actions/upload-artifact@v4
      with:
        name: all-deleted-folders-in-${{ matrix.config.environment }}-${{ strategy.job-index }}
        include-hidden-files: true
        #retention-days: 5
        path: |
          ${{ matrix.config.path  }}/tfplan
          ${{ matrix.config.path  }}/.terraform
          ${{ matrix.config.path  }}/.terraform.lock.hcl